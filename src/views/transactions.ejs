<%- include('header') %>
<link rel="stylesheet" href="/stylesheets/transaction2.css">

<div class="container" style="display: flex; gap: 20px; align-items: flex-start;">
    <!-- Formulario de transacciones -->
    <div>
        <h1>Add Transaction</h1>

        <form action="/transactions/add" method="POST" class="transaction-form">
            <div class="form-group">
                <label for="tipo">Type:</label>
                <select name="tipo" id="tipo" required>
                    <option value="INGRESO">Ingreso</option>
                    <option value="GASTO">Gasto</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dinero">Amount:</label>
                <input type="number" name="dinero" id="dinero" step="0.01" placeholder="Cantidad" required>
            </div>

            <div class="form-group">
                <label for="descripcion">Description:</label>
                <input type="text" name="descripcion" id="descripcion" placeholder="Descripción">
            </div>

            <div class="form-group">
                <label for="fecha">Date:</label>
                <input type="date" name="fecha" id="fecha" required>
            </div>

            <div class="form-group">
                <label for="id_cuenta">Account:</label>
                <select name="id_cuenta" id="id_cuenta" required>
                    <% cuentas.forEach(cuenta=> { %>
                        <option value="<%= cuenta.id %>">
                            <%= cuenta.id %> - Balance: €<%= cuenta.saldo %>
                        </option>
                        <% }); %>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Add</button>
        </form>
    </div>

    <!-- Tarjeta de crédito -->
    <div class="flip-card">
        <div class="flip-card-inner">
            <div class="flip-card-front">
                <p class="heading_8264">CASHME CARD</p>
                <svg version="1.1" class="chip" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 50 50" xml:space="preserve">  <image id="image0" width="50" height="50" x="0" y="0" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAABGdBTUEAALGPC/xhBQAAACBjSFJN
                  AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAB6VBMVEUAAACNcTiVeUKVeUOY
                  fEaafEeUeUSYfEWZfEaykleyklaXe0SWekSZZjOYfEWYe0WXfUWXe0WcgEicfkiXe0SVekSXekSW
                  ekKYe0a9nF67m12ZfUWUeEaXfESVekOdgEmVeUWWekSniU+VeUKVeUOrjFKYfEWliE6WeESZe0GS
                  e0WYfES7ml2Xe0WXeESUeEOWfEWcf0eWfESXe0SXfEWYekSVeUKXfEWxklawkVaZfEWWekOUekOW
                  ekSYfESZe0eXekWYfEWZe0WZe0eVeUSWeETAnmDCoWLJpmbxy4P1zoXwyoLIpWbjvXjivnjgu3bf
                  u3beunWvkFWxkle/nmDivXiWekTnwXvkwHrCoWOuj1SXe0TEo2TDo2PlwHratnKZfEbQrWvPrWua
                  fUfbt3PJp2agg0v0zYX0zYSfgkvKp2frxX7mwHrlv3rsxn/yzIPgvHfduXWXe0XuyIDzzISsjVO1
                  lVm0lFitjVPzzIPqxX7duna0lVncuHTLqGjvyIHeuXXxyYGZfUayk1iyk1e2lln1zYTEomO2llrb
                  tnOafkjFpGSbfkfZtXLhvHfkv3nqxH3mwXujhU3KqWizlFilh06khk2fgkqsjlPHpWXJp2erjVOh
                  g0yWe0SliE+XekShhEvAn2D///+gx8TWAAAARnRSTlMACVCTtsRl7Pv7+vxkBab7pZv5+ZlL/UnU
                  /f3SJCVe+Fx39naA9/75XSMh0/3SSkia+pil/KRj7Pr662JPkrbP7OLQ0JFOijI1MwAAAAFiS0dE
                  orDd34wAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfnAg0IDx2lsiuJAAACLElEQVRIx2Ng
                  GAXkAUYmZhZWPICFmYkRVQcbOwenmzse4MbFzc6DpIGXj8PD04sA8PbhF+CFaxEU8iWkAQT8hEVg
                  OkTF/InR4eUVICYO1SIhCRMLDAoKDvFDVhUaEhwUFAjjSUlDdMiEhcOEItzdI6OiYxA6YqODIt3d
                  I2DcuDBZsBY5eVTr4xMSYcyk5BRUOXkFsBZFJTQnp6alQxgZmVloUkrKYC0qqmji2WE5EEZuWB6a
                  lKoKdi35YQUQRkFYPpFaCouKIYzi6EDitJSUlsGY5RWVRGjJLyxNy4ZxqtIqqvOxaVELQwZFZdkI
                  JVU1RSiSalAt6rUwUBdWG1CP6pT6gNqwOrgCdQyHNYR5YQFhDXj8MiK1IAeyN6aORiyBjByVTc0F
                  qBoKWpqwRCVSgilOaY2OaUPw29qjOzqLvTAchpos47u6EZyYnngUSRwpuTe6D+6qaFQdOPNLRzOM
                  1dzhRZyW+CZouHk3dWLXglFcFIflQhj9YWjJGlZcaKAVSvjyPrRQ0oQVKDAQHlYFYUwIm4gqExGm
                  BSkutaVQJeomwViTJqPK6OhCy2Q9sQBk8cY0DxjTJw0lAQWK6cOKfgNhpKK7ZMpUeF3jPa28BCET
                  amiEqJKM+X1gxvWXpoUjVIVPnwErw71nmpgiqiQGBjNzbgs3j1nus+fMndc+Cwm0T52/oNR9lsdC
                  S24ra7Tq1cbWjpXV3sHRCb1idXZ0sGdltXNxRateRwHRAACYHutzk/2I5QAAACV0RVh0ZGF0ZTpj
                  cmVhdGUAMjAyMy0wMi0xM1QwODoxNToyOSswMDowMEUnN7UAAAAldEVYdGRhdGU6bW9kaWZ5ADIw
                  MjMtMDItMTNUMDg6MTU6MjkrMDA6MDA0eo8JAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTAy
                  LTEzVDA4OjE1OjI5KzAwOjAwY2+u1gAAAABJRU5ErkJggg=="></image>
                </svg>
                <svg version="1.1" class="contactless" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="20px" height="20px" viewBox="0 0 50 50" xml:space="preserve">  <image id="image0" width="50" height="50" x="0" y="0" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAQAAAC0NkA6AAAABGdBTUEAALGPC/xhBQAAACBjSFJN
                  AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZ
                  cwAACxMAAAsTAQCanBgAAAAHdElNRQfnAg0IEzgIwaKTAAADDklEQVRYw+1XS0iUURQ+f5qPyjQf
                  lGRFEEFK76koKGxRbWyVVLSOgsCgwjZBJJYuKogSIoOonUK4q3U0WVBWFPZYiIE6kuArG3VGzK/F
                  fPeMM/MLt99/NuHdfPd888/57jn3nvsQWWj/VcMlvMMd5KRTogqx9iCdIjUUmcGR9ImUYowyP3xN
                  GQJoRLVaZ2DaZf8kyjEJALhI28ELioyiwC+Rc3QZwRYyO/DH51hQgWm6DMIh10KmD4u9O16K49it
                  VoPOAmcGAWWOepXIRScAoJZ2Frro8oN+EyTT6lWkkg6msZfMSR35QTJmjU0g15tIGSJ08ZZMJkJk
                  HpNZgSkyXosS13TkJpZ62mPIJvOSzC1bp8vRhhCakEk7G9/o4gmZdbpsTcKu0m63FbnBP9Qrc15z
                  bkbemfgNDtEOI8NO5L5O9VYyRYgmJayZ9nPaxZrSjW4+F6Uw9yQqIiIZwhp2huQTf6OIvCZyGM6g
                  DJBZbyXifJXr7FZjGXsdxADxI7HUJFB6iWvsIhFpkoiIiGTJfjJfiCuJg2ZEspq9EHGVpYgzKqwJ
                  qSAOEwuJQ/pxPvE3cYltJCLdxBLiSKKIE5HxJKcTRNeadxfhDiuYw44zVs1dxKwRk/uCxIiQkxKB
                  sSctRVAge9g1E15EHE6yRUaJecRxcWlukdRIbGFOSZCMWQA/iWauIP3slREHXPyliqBcrrD71Amz
                  Z+rD1Mt2Yr8TZc/UR4/YtFnbijnHi3UrN9vKQ9rPaJf867ZiaqDB+czeKYmd3pNa6fuI75MiC0uX
                  XSR5aEMf7s7a6r/PudVXkjFb/SsrCRfROk0Fx6+H1i9kkTGn/E1vEmt1m089fh+RKdQ5O+xNJPUi
                  cUIjO0Dm7HwvErEr0YxeibL1StSh37STafE4I7zcBdRq1DiOkdmlTJVnkQTBTS7X1FYyvfO4piaI
                  nKbDCDaT2anLudYXCRFsQBgAcIF2/Okwgvz5+Z4tsw118dzruvIvjhTB+HOuWy8UvovEH6beitBK
                  xDyxm9MmISKCWrzB7bSlaqGlsf0FC0gMjzTg6GgAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjMtMDIt
                  MTNUMDg6MTk6NTYrMDA6MDCjlq7LAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIzLTAyLTEzVDA4OjE5
                  OjU2KzAwOjAw0ssWdwAAACh0RVh0ZGF0ZTp0aW1lc3RhbXAAMjAyMy0wMi0xM1QwODoxOTo1Nisw
                  MDowMIXeN6gAAAAASUVORK5CYII="></image>
                </svg>
                <p class="number">9759 2484 5269 6576</p>
                <p class="valid_thru">VALID THRU</p>
                <p class="date_8264">1 2 / 2 4</p>
                <p class="name"><%= user.nombre %></p>
                <img class="logo" src="/images/logo.png" alt="Cashmelogo" style="position: absolute; bottom: 10px; right: 10px; width: 70px; height: 70px; object-fit: contain; border-radius: 5px;">
            </div>
            <div class="flip-card-back">
                <div class="strip"></div>
                <div class="mstrip"></div>
                <div class="sstrip">
                  <p class="code">***</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historial de transacciones -->
<div class="transactions-container">
    <h2>Transaction History</h2>
    <form action="/transactions" method="GET" id="filter-form">
        <select name="id_cuenta" id="id_cuenta" onchange="document.getElementById('filter-form').submit();">
            <option value="">All Accounts</option>
            <% cuentas.forEach(cuenta=> { %>
                <option value="<%= cuenta.id %>" <%=cuenta.id==selectedCuentaId ? 'selected' : '' %>>
                    Account <%= cuenta.id %> - Balance: €<%= cuenta.saldo %>
                </option>
                <% }); %>
        </select>
    </form>
    <br>
    <ul class="transactions-list">
        <% if (transactions.length> 0) { %>
            <% transactions.forEach(transaction=> { %>
                <li class="transaction-item <%= transaction.tipo === 'INGRESO' ? 'income' : 'expense' %>">
                    <div class="transaction-info">
                        <% cuentas.forEach(cuenta=> { %>
                            <% if (cuenta.id===transaction.id_cuenta) { %>
                                <strong>Cuenta <%= cuenta.id %> - <%= transaction.tipo==='INGRESO' ? 'Ingreso' : 'Gasto'
                                            %></strong>:
                                $<%= transaction.dinero.toFixed(2) %> (<%= transaction.descripcion %>) [<%=
                                            transaction.fecha %>]
                                            <% } %>
                                                <% }); %>
                    </div>
                    <form action="/transactions/delete/<%= transaction.id %>" method="POST" class="delete-form">
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                </li>
                <% }); %>
                    <% } else { %>
                        <p>No hay transacciones registradas.</p>
                        <% } %>
    </ul>
</div>

<!-- Import Data Start -->
<div class=" importExpenses container mt-5">
    <h1>Import Expenses</h1>
    <input type="file" id="fileInput" accept=".xls,.xlsx">
    <button id="import-btn" onclick="importKutxabankData()">Import</button>
    <div id="result"></div>

    <!-- Select account and save button -->
    <div id="importControls" style="display: none;">
        <h2> Select an Account </h2>
        <select name="id_cuenta" id="id_cuenta" onchange="">
            <option value="">All Accounts</option>
            <% cuentas.forEach(cuenta=> { %>
                <option value="<%= cuenta.id %>" <%=cuenta.id==selectedCuentaId ? 'selected' : '' %>>
                    Account <%= cuenta.id %> - Balance: €<%= cuenta.saldo %>
                </option>
            <% }); %>
        </select>
        <button id="save-import-btn" onclick="saveImportData()">Save Imported Data</button>
    </div>
</div>
<!-- Import Data End -->

<script>
    let importedData = [];

    function importKutxabankData() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) {
            alert('Please select a file first.');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        fetch('/transactions/importKutxabank', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error processing the request: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Imported data:', data);
            importedData = data; // Store the imported data for later use
            displayDataAsTable(data);

            // Show the select and save button after successful import
            document.getElementById('importControls').style.display = 'block';
        })
        .catch(error => {
            console.log('Error importing the data:', error);
            alert('There was a problem importing the data. Please try again.');
        });
    }

    function displayDataAsTable(data) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = ''; 

        const table = document.createElement('table');
        table.classList.add('table', 'table-bordered', 'table-hover');

        // Create table headers
        const headers = Object.keys(data[0]);
        let thead = table.createTHead();
        let row = thead.insertRow();
        headers.forEach(header => {
            let th = document.createElement('th');
            th.textContent = header;
            row.appendChild(th);
        });

        // Create table body
        let tbody = table.createTBody();
        data.forEach(item => {
            let row = tbody.insertRow();
            headers.forEach(header => {
                let cell = row.insertCell();
                cell.textContent = item[header];
            });
        });

        resultDiv.appendChild(table);
    }

    function saveImportData() {
        if (importedData.length === 0) {
            alert('No data to save. Please import data first.');
            return;
        }

        const accountSelect = document.getElementById('id_cuenta');
        const selectedAccountId = accountSelect.value;

        if (!selectedAccountId) {
            alert('Please select an account to save the data.');
            return;
        }

        fetch('/transactions/add-import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                transactions: importedData,
                accountId: selectedAccountId // Asegúrate de que este valor se obtenga de 'id_cuenta'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error saving the imported data: ' + response.statusText);
            }
            alert('Imported data saved successfully');
        })
        .catch(error => {
            console.error('Error saving imported data:', error);
            alert('There was a problem saving the data. Please try again.');
        });
    }
</script>

<%- include('footer') %>
